<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kitchen Dashboard ‚Äì Kholm (Bar Only)</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px 0 56px 0;
    }
    h1 {
      color: #4e342e;
      text-align: center;
    }
    .top-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .top-bar button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .order-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 15px auto;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-left: 8px solid #ccc;
      transition: transform 0.2s ease;
    }
    .order-card:hover {
      transform: scale(1.02);
    }
    .order-card h3 {
      margin-top: 0;
      font-size: 20px;
      color: #5d4037;
    }
    .order-card ul {
      padding-left: 20px;
      margin: 10px 0;
    }
    .order-card li {
      margin: 6px 0;
    }
    .status-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    .status-buttons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #fff;
    }
    .pending { background-color: #ff9800; }
    .processing { background-color: #03a9f4; }
    .completed { background-color: #4caf50; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>üç∏ Bar Orders Only ‚Äì Kholmay</h1>
  <div class="top-bar">
    <button id="showOrders">üìã Orders</button>
    <button id="showHistory">‚úÖ Completed</button>
  </div>

  <div id="orders"></div>
  <div id="history" class="hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded, onChildChanged, onValue, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATGDe4NI75RSny4ZbE3WDtaUoUivjv3E8",
      authDomain: "digital-menu-woodengarden.firebaseapp.com",
      projectId: "digital-menu-woodengarden",
      storageBucket: "digital-menu-woodengarden.appspot.com",
      messagingSenderId: "247699180208",
      appId: "1:247699180208:web:662d9f65a109d8d299e93e",
      measurementId: "G-V37D4KZH4R",
      databaseURL: "https://digital-menu-woodengarden-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ordersRef = ref(db, 'orders');
    const completedRef = ref(db, 'completedOrders');

    const ordersDiv = document.getElementById("orders");
    const historyDiv = document.getElementById("history");
    const showOrdersBtn = document.getElementById("showOrders");
    const showHistoryBtn = document.getElementById("showHistory");

    const ordersMap = {};
    const completedMap = {};

    const excludedCategories = [
      "Hot Beverages",
      "Cold Beverage",
      "Iced Coffee Alternatives",
      "Blended Beverage",
      "Icecream",
      "V60",
      "Soft Drinks",
      "Lassi",
      "Hot Drinks Alternatives"
    ];

    showOrdersBtn.onclick = () => {
      ordersDiv.classList.remove("hidden");
      historyDiv.classList.add("hidden");
    };

    showHistoryBtn.onclick = () => {
      historyDiv.classList.remove("hidden");
      ordersDiv.classList.add("hidden");
    };

    function createOrderCard(order, key, showStatusButtons = true) {
      if (!order.items || !Array.isArray(order.items)) return null;

      const allBarItems = order.items.every(item => excludedCategories.includes(item.category));
      if (!allBarItems) return null;

      let orderName = order.name || (order.items[0] && order.items[0].name) || "Unnamed Order";

      const card = document.createElement("div");
      card.className = "order-card";
      card.id = `order-${key}`;

      card.innerHTML = `
        <h3>${orderName}</h3>
        <ul>
          ${order.items.map(item => `
            <li>${item.name} ‚Äì Qty: ${item.quantity} ‚Äì Rs. ${item.price || 0}</li>
          `).join('')}
        </ul>
        ${showStatusButtons ? `
        <div class="status-buttons">
          <button class="pending">Pending</button>
          <button class="processing">Processing</button>
          <button class="completed">Completed</button>
        </div>` : ""}
      `;

      if (showStatusButtons) {
        const [pendingBtn, processingBtn, completedBtn] = card.querySelectorAll("button");

        pendingBtn.onclick = () => card.style.borderLeftColor = "#ff9800";
        processingBtn.onclick = () => card.style.borderLeftColor = "#03a9f4";
        completedBtn.onclick = () => {
          remove(ref(db, `orders/${key}`));
          const completedData = { ...order, completedAt: new Date().toISOString() };
          const newRef = ref(db, `completedOrders/${key}`);
          set(newRef, completedData);
        };
      }

      return card;
    }

    function renderOrders() {
      ordersDiv.innerHTML = '';
      for (const key in ordersMap) {
        const card = createOrderCard(ordersMap[key], key, true);
        if (card) ordersDiv.appendChild(card);
      }
      sortOrderCards(ordersDiv);
    }

    function renderHistory() {
      historyDiv.innerHTML = '';
      for (const key in completedMap) {
        const card = createOrderCard(completedMap[key], key, false);
        if (card) historyDiv.appendChild(card);
      }
      sortOrderCards(historyDiv);
    }

    function sortOrderCards(container) {
      const cards = Array.from(container.children);
      cards.sort((a, b) => a.id.localeCompare(b.id));
      cards.forEach(card => container.appendChild(card));
    }

    onChildAdded(ordersRef, (snapshot) => {
      const key = snapshot.key;
      const order = snapshot.val();
      ordersMap[key] = order;

      const card = createOrderCard(order, key, true);
      if (card) ordersDiv.appendChild(card);
      sortOrderCards(ordersDiv);
    });

    onChildChanged(ordersRef, (snapshot) => {
      const key = snapshot.key;
      const order = snapshot.val();
      ordersMap[key] = order;

      const oldCard = document.getElementById(`order-${key}`);
      if (oldCard) oldCard.remove();

      const card = createOrderCard(order, key, true);
      if (card) ordersDiv.appendChild(card);
      sortOrderCards(ordersDiv);
    });

    onValue(completedRef, (snapshot) => {
      completedMap = {};
      snapshot.forEach(child => {
        completedMap[child.key] = child.val();
      });
      renderHistory();
    });
  </script>
</body>
</html>